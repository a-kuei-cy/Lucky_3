<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Âπ∏ÈÅãÂ§ßËΩâÁõ§</title>
    
    <!-- ÂºïÂÖ• React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ÂºïÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
      body { font-family: 'Noto Sans TC', sans-serif; }
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // =================================================================
      // ‚ö†Ô∏è Ë´ãÂú®Ê≠§ËôïË≤º‰∏äÊÇ®ÁöÑ Google Apps Script ÈÉ®ÁΩ≤Á∂≤ÂùÄ
      // ‰æãÂ¶Ç: https://script.google.com/macros/s/AKfycbx.../exec
      // =================================================================
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzgxuAajeQgaDxmI06uF8zotDKEvbuNw_xo-Nyo2sXvyAEQl1a2b2dnnJEYAmgbaAEn/exec"; 

      // ---------------------------------------------------------
      // üì° API ÈÄöË®äÂ±§ (Âèñ‰ª£ google.script.run)
      // ---------------------------------------------------------
      const api = {
        call: async (action, payload = {}) => {
          // Â¶ÇÊûúÊ≤íÊúâÂ°´Á∂≤ÂùÄÔºå‰ΩøÁî®Ê®°Êì¨Êï∏Êìö (ÈÅøÂÖçÂ†±ÈåØ)
          if (GAS_API_URL.includes("ÊÇ®ÁöÑ_WEB_APP_URL")) {
            console.warn("Â∞öÊú™Ë®≠ÂÆö API URLÔºå‰ΩøÁî®Ê®°Êì¨Ê®°Âºè");
            return mockApi(action, payload);
          }

          try {
            // ‰ΩøÁî® fetch ÁôºÈÄÅ POST Ë´ãÊ±Ç
            // Google Apps Script Web App È†êË®≠ÊúÉËôïÁêÜ CORS ÈáçÂ∞éÂêëÔºåfetch ÊúÉËá™ÂãïË∑üÈö®
            const response = await fetch(GAS_API_URL, {
              method: "POST",
              // ‰ΩøÁî® text/plain ÂèØ‰ª•ÈÅøÂÖçÊüê‰∫õÁÄèË¶ΩÂô®ÁöÑ CORS È†êÊ™¢Ë´ãÊ±Ç (Preflight) ÂïèÈ°å
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify({ action, ...payload })
            });
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("API Error:", error);
            throw new Error("ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñ API Á∂≤ÂùÄ");
          }
        }
      };

      // Ê®°Êì¨ API (Áï∂‰ΩøÁî®ËÄÖÂøòË®òÂ°´ URL ÊôÇ‰ΩøÁî®)
      const mockApi = (action, payload) => {
         return new Promise((resolve) => {
            setTimeout(() => {
                if (action === 'getPrizes') resolve([
                    {id:1, name:"(Ë´ãË®≠ÂÆöAPIÁ∂≤ÂùÄ)", quantity:1, color:"#ddd"},
                    {id:2, name:"GitHubÊ®°Âºè", quantity:5, color:"#eee"}
                ]);
                else if (action === 'checkAdminPassword') resolve({ isValid: true });
                else resolve({ status: "success", winnerId: 1, remaining: 0 });
            }, 500);
         });
      }

      // ---------------------------------------------------------
      // üé® ÂúñÊ®ôÁµÑ‰ª∂ (Icons)
      // ---------------------------------------------------------
      const IconBase = ({ children, className, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
      const Settings = (props) => (<IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>);
      const Plus = (props) => (<IconBase {...props}><path d="M5 12h14" /><path d="M12 5v14" /></IconBase>);
      const Trash2 = (props) => (<IconBase {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></IconBase>);
      const X = (props) => (<IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>);
      const Save = (props) => (<IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>);
      const RefreshCw = (props) => (<IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>);
      const Gift = (props) => (<IconBase {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect width="20" height="5" x="2" y="7" /><line x1="12" x2="12" y1="22" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></IconBase>);
      const Trophy = (props) => (<IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></IconBase>);
      const Loader2 = (props) => (<IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></IconBase>);
      const Lock = (props) => (<IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>);

      function App() {
        const [prizes, setPrizes] = useState([]);
        const [loading, setLoading] = useState(true);
        const [isSpinning, setIsSpinning] = useState(false);
        const [winner, setWinner] = useState(null);
        const [rotation, setRotation] = useState(0);
        
        // Admin
        const [showLoginModal, setShowLoginModal] = useState(false);
        const [showAdminModal, setShowAdminModal] = useState(false);
        const [passwordInput, setPasswordInput] = useState("");
        const [loginError, setLoginError] = useState("");
        const [editingPrizes, setEditingPrizes] = useState([]);
        const [isSaving, setIsSaving] = useState(false);

        const canvasRef = useRef(null);

        // Fetch Data using new API
        const fetchPrizes = async () => {
          setLoading(true);
          try {
            const data = await api.call('getPrizes');
            if (Array.isArray(data)) {
              setPrizes(data);
              setEditingPrizes(JSON.parse(JSON.stringify(data)));
            }
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          fetchPrizes();
        }, []);

        // Canvas Logic
        const activePrizes = prizes.filter(p => p.quantity > 0);
        const displayPrizes = activePrizes.length > 0 ? activePrizes : [];

        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          const width = canvas.width;
          const height = canvas.height;
          const centerX = width / 2;
          const centerY = height / 2;
          const radius = width / 2 - 10;

          ctx.clearRect(0, 0, width, height);

          if (displayPrizes.length === 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#e2e8f0';
            ctx.fill();
            ctx.fillStyle = '#94a3b8';
            ctx.font = '24px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(loading ? "ËÆÄÂèñ‰∏≠..." : "ÁçéÈ†ÖÂ∑≤Á©∫", centerX, centerY);
            return;
          }

          const arcSize = (2 * Math.PI) / displayPrizes.length;

          displayPrizes.forEach((prize, index) => {
            const startAngle = index * arcSize - Math.PI / 2;
            const endAngle = startAngle + arcSize;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.fillStyle = prize.color;
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#ffffff";
            ctx.stroke();

            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(startAngle + arcSize / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 4;
            ctx.font = "bold 18px sans-serif";
            ctx.fillText(prize.name.substring(0, 8), radius - 20, 5);
            ctx.font = "12px sans-serif";
            ctx.fillText(`(Ââ©${prize.quantity})`, radius - 20, 24);
            ctx.restore();
          });
        }, [prizes, loading, displayPrizes.length]);

        // Spin Logic
        const handleSpin = async () => {
          if (isSpinning || displayPrizes.length === 0) return;
          setIsSpinning(true);
          setWinner(null);

          try {
            const result = await api.call('runLottery');
            
            if (result.error) {
              alert(result.message);
              fetchPrizes();
              return;
            }
            performSpinAnimation(result);
          } catch (e) {
            alert(e.message);
            setIsSpinning(false);
          }
        };

        const perf
